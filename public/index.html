<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>US Railway Cargo SSE Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }

    body {
      margin: 0;
      padding: 1rem;
      background: #0b1120;
      color: #e5e7eb;
    }

    h1 {
      margin-top: 0;
      font-size: 1.5rem;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 1rem;
    }

    .card {
      background: #020617;
      border-radius: 0.75rem;
      padding: 1rem;
      border: 1px solid #1f2937;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
    }

    label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
      margin-bottom: 0.25rem;
    }

    input, select {
      width: 100%;
      padding: 0.35rem 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.4rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: #22c55e;
      color: #020617;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    button.secondary {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-top: 0.5rem;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem 0.75rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      border-radius: 999px;
      padding: 0.1rem 0.6rem;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .pill.green {
      background: rgba(34, 197, 94, 0.1);
      color: #4ade80;
    }

    .pill.blue {
      background: rgba(56, 189, 248, 0.1);
      color: #38bdf8;
    }

    .pill.amber {
      background: rgba(251, 191, 36, 0.1);
      color: #fbbf24;
    }

    .pill.red {
      background: rgba(248, 113, 113, 0.1);
      color: #f97373;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-top: 0.25rem;
      color: #9ca3af;
    }

    .stat-row strong {
      color: #e5e7eb;
    }

    .train-list {
      max-height: 420px;
      overflow: auto;
      margin-top: 0.5rem;
      padding-right: 0.25rem;
    }

    .train {
      border-radius: 0.75rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid #1f2937;
      margin-bottom: 0.5rem;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.15), transparent 60%);
    }

    .train-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
    }

    .train-name {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .train-meta {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .route {
      margin-top: 0.35rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .route span {
      display: inline-flex;
      align-items: center;
    }

    .route span::after {
      content: "—";
      margin: 0 0.25rem;
      opacity: 0.5;
    }

    .route span:last-child::after {
      content: "";
      margin: 0;
    }

    .prog-bar {
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: #020617;
      margin-top: 0.3rem;
      overflow: hidden;
      border: 1px solid #1f2937;
    }

    .prog-fill {
      height: 100%;
      background: linear-gradient(90deg, #38bdf8, #22c55e);
      transition: width 0.3s linear;
    }

    .cars-summary {
      margin-top: 0.35rem;
      font-size: 0.75rem;
      color: #9ca3af;
    }

    pre {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
      background: #020617;
      border-radius: 0.75rem;
      padding: 0.75rem;
      border: 1px solid #1f2937;
      max-height: 380px;
      overflow: auto;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f97372;
      display: inline-block;
    }

    .status-dot.connected {
      background: #22c55e;
    }

    .status-row {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .status-time {
      font-size: 0.7rem;
      opacity: 0.8;
    }

    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>US Railway Cargo SSE Dashboard</h1>
  <div class="app">
    <div class="card">
      <div>
        <div class="status-row">
          <span class="status-dot" id="conn-dot"></span>
          <span id="conn-text">Disconnected</span>
          <span class="status-time" id="last-event-time"></span>
        </div>

        <div class="filters-grid" style="margin-top:0.5rem;">
          <div>
            <label for="awb">Airway bill (awb)</label>
            <input id="awb" placeholder="e.g. AWB-1" />
          </div>
          <div>
            <label for="trainName">Train name</label>
            <input id="trainName" placeholder="e.g. Pacific" />
          </div>
          <div>
            <label for="carNumber">Car number</label>
            <input id="carNumber" placeholder="e.g. R1001" />
          </div>
          <div>
            <label for="station">Station code</label>
            <input id="station" placeholder="e.g. CHI" />
          </div>
          <div>
            <label for="status">Status</label>
            <select id="status">
              <option value="">Any</option>
              <option value="LOADED">LOADED</option>
              <option value="IN_TRANSIT">IN_TRANSIT</option>
              <option value="DELIVERED">DELIVERED</option>
            </select>
          </div>
        </div>

        <div class="controls">
          <button id="connect-btn">Connect</button>
          <button class="secondary" id="disconnect-btn" disabled>Disconnect</button>
          <span class="pill blue">
            <span>Endpoint</span>
            <code style="font-size:0.7rem;">/SSE/Stream</code>
          </span>
        </div>

        <div class="stat-row">
          <span>Trains visible</span>
          <strong id="stat-trains">0</strong>
        </div>
        <div class="stat-row">
          <span>Cars</span>
          <strong id="stat-cars">0</strong>
        </div>
        <div class="stat-row">
          <span>Airway bills</span>
          <strong id="stat-awbs">0</strong>
        </div>
      </div>

      <div class="train-list" id="train-list"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-size:0.9rem;font-weight:600;">Raw payload</div>
          <div style="font-size:0.75rem;color:#9ca3af;">Last SSE message</div>
        </div>
        <div class="pill amber" id="filters-pill">
          Filters: none
        </div>
      </div>
      <pre id="raw-json">{}</pre>
    </div>
  </div>

  <script>
    const connectBtn = document.getElementById("connect-btn");
    const disconnectBtn = document.getElementById("disconnect-btn");
    const connDot = document.getElementById("conn-dot");
    const connText = document.getElementById("conn-text");
    const lastEventTime = document.getElementById("last-event-time");
    const rawJson = document.getElementById("raw-json");
    const trainList = document.getElementById("train-list");
    const filtersPill = document.getElementById("filters-pill");

    const awbInput = document.getElementById("awb");
    const trainNameInput = document.getElementById("trainName");
    const carNumberInput = document.getElementById("carNumber");
    const stationInput = document.getElementById("station");
    const statusSelect = document.getElementById("status");

    const statTrains = document.getElementById("stat-trains");
    const statCars = document.getElementById("stat-cars");
    const statAwbs = document.getElementById("stat-awbs");

    let es = null;

    function buildQueryString() {
      const params = new URLSearchParams();

      if (awbInput.value.trim()) params.set("awb", awbInput.value.trim());
      if (trainNameInput.value.trim()) params.set("trainName", trainNameInput.value.trim());
      if (carNumberInput.value.trim()) params.set("carNumber", carNumberInput.value.trim());
      if (stationInput.value.trim()) params.set("station", stationInput.value.trim());
      if (statusSelect.value.trim()) params.set("status", statusSelect.value.trim());

      return params.toString();
    }

    function describeFilters() {
      const parts = [];
      if (awbInput.value.trim()) parts.push(`awb=${awbInput.value.trim()}`);
      if (trainNameInput.value.trim()) parts.push(`train=${trainNameInput.value.trim()}`);
      if (carNumberInput.value.trim()) parts.push(`car=${carNumberInput.value.trim()}`);
      if (stationInput.value.trim()) parts.push(`stn=${stationInput.value.trim()}`);
      if (statusSelect.value.trim()) parts.push(`status=${statusSelect.value.trim()}`);
      return parts.length === 0 ? "Filters: none" : `Filters: ${parts.join(" · ")}`;
    }

    function setConnected(connected) {
      connDot.classList.toggle("connected", connected);
      connText.textContent = connected ? "Connected" : "Disconnected";
      connectBtn.disabled = connected;
      disconnectBtn.disabled = !connected;
    }

    function renderTrains(payload) {
      const trains = payload.trains || [];
      statTrains.textContent = trains.length.toString();

      let totalCars = 0;
      let totalAwbs = 0;

      trainList.innerHTML = "";

      trains.forEach((t) => {
        const cars = t.cars || [];
        totalCars += cars.length;
        cars.forEach((c) => {
          totalAwbs += (c.airwayBills || []).length;
        });

        const div = document.createElement("div");
        div.className = "train";

        const header = document.createElement("div");
        header.className = "train-header";

        const left = document.createElement("div");
        const name = document.createElement("div");
        name.className = "train-name";
        name.textContent = t.name;

        const meta = document.createElement("div");
        meta.className = "train-meta";
        meta.textContent = `Speed ${t.speedKmh} km/h · Leg ${t.fromStationCode} → ${t.toStationCode} · ${Math.round((t.legProgress || 0) * 100)}%`;

        left.appendChild(name);
        left.appendChild(meta);

        const pill = document.createElement("div");
        pill.className = "pill green";
        pill.textContent = `${cars.length} cars`;

        header.appendChild(left);
        header.appendChild(pill);

        const route = document.createElement("div");
        route.className = "route";
        (t.route || []).forEach((code) => {
          const span = document.createElement("span");
          span.textContent = code;
          route.appendChild(span);
        });

        const progOuter = document.createElement("div");
        progOuter.className = "prog-bar";
        const progInner = document.createElement("div");
        progInner.className = "prog-fill";
        progInner.style.width = `${Math.round((t.legProgress || 0) * 100)}%`;
        progOuter.appendChild(progInner);

        const carsSummary = document.createElement("div");
        carsSummary.className = "cars-summary";
        carsSummary.textContent = `Lat ${t.currentLocation?.lat}, Lon ${t.currentLocation?.lon}`;

        div.appendChild(header);
        div.appendChild(route);
        div.appendChild(progOuter);
        div.appendChild(carsSummary);

        trainList.appendChild(div);
      });

      statCars.textContent = totalCars.toString();
      statAwbs.textContent = totalAwbs.toString();
    }

    function connect() {
      if (es) {
        es.close();
        es = null;
      }

      const qs = buildQueryString();
      const url = qs ? `/SSE/Stream?${qs}` : "/SSE/Stream";

      es = new EventSource(url);

      setConnected(true);
      filtersPill.textContent = describeFilters();

      es.addEventListener("railUpdate", (ev) => {
        const now = new Date();
        lastEventTime.textContent = `Last event: ${now.toLocaleTimeString()}`;
        try {
          const payload = JSON.parse(ev.data);
          rawJson.textContent = JSON.stringify(payload, null, 2);
          renderTrains(payload);
        } catch (e) {
          console.error("Error parsing SSE payload", e);
        }
      });

      es.onerror = () => {
        setConnected(false);
      };
    }

    function disconnect() {
      if (es) {
        es.close();
        es = null;
      }
      setConnected(false);
    }

    connectBtn.addEventListener("click", connect);
    disconnectBtn.addEventListener("click", disconnect);

    // Auto-connect on load
    connect();
  </script>
</body>
</html>
